machine:
  environment:
    # make our gopath first in gopath list
    TEMP_GOPATH: ${HOME}/temp_gopath
    GOPATH: $TEMP_GOPATH:$GOPATH

dependencies:
  pre:
    - sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get -y install libssl-dev build-essential python-dev python3-dev python-setuptools python3-setuptools
    - git clone https://github.com/cossacklabs/themis && cd themis && sudo make install

  override:
    - make
    - sudo make install
    - make examples
    - sudo pip install tox
    - pyenv global 2.7.12 3.3.6 3.4.4 3.5.3 3.6.2
    - mkdir -p db/credential_store db/key_store db/data_store
    - cp ./docs/examples/c/service_keys/* db/credential_store/
    - cp ./docs/examples/test_keys/* db/credential_store/
    - |
      mkdir -p $TEMP_GOPATH/src/github.com/cossacklabs &&
      ln -s ${HOME}/${CIRCLE_PROJECT_REPONAME} $TEMP_GOPATH/src/github.com/cosascklabs/${CIRCLE_PROJECT_REPONAME}  &&
      go get github.com/cossacklabs/hermes-core/docs/examples/go/... &&
      go build docs/examples/go/hermes_client.go


test:
  override:
    #- make test
    # run only TestHermesTransport until add support of running stores
    - |
      rm -rf db/key_store/* ;
      rm -rf db/data_store/* ;
      ./docs/examples/c/mid_hermes/credential_store_service/cs &  export CS_PID=$!;
      ./docs/examples/c/mid_hermes/key_store_service/ks & export KS_PID=$! ;
      ./docs/examples/c/mid_hermes/data_store_service/ds & export DS_PID=$!;
      cd pyhermes ;
      tox -e py33,py34,py35,py36,py27 -- python -m unittest test.TestHermesTransport test.TestHermes.test_secure_midhermes || \
      kill -9 $CS_PID $KS_PID $DS_PID

    - |
      rm -rf db/key_store/*;
      rm -rf db/data_store/*;
      ./docs/examples/c/mid_hermes/credential_store_service/cs &  export CS_PID=$!; 
      ./docs/examples/c/mid_hermes/key_store_service/ks & export KS_PID=$! ; 
      ./docs/examples/c/mid_hermes/data_store_service/ds & export DS_PID=$!; 
      sh docs/examples/go/tests/go_test.sh;
      kill -9 $CS_PID $KS_PID $DS_PID
